# P9: Internationalization (i18n)

## 背景与目标

RRClaw 当前所有 system prompt、CLI 消息、内置 skill 均为中文，不适合开源后的英文用户使用。

P9 的目标：**将默认语言改为英文**，中文用户通过 `language = "zh"` 恢复中文体验。

### 语言设置控制什么

| 影响项 | 说明 |
|--------|------|
| System prompt 语言 | LLM 读到的身份描述、工具说明、决策原则 |
| Phase 1 routing prompt 语言 | Skill 描述的语言，影响英文消息的路由准确性 |
| CLI 消息语言 | 用户看到的确认提示、欢迎语、帮助文本 |
| 内置 skill 内容语言 | Skill 的行为指南文本 |

### 语言设置**不**控制什么

| 项目 | 说明 |
|------|------|
| LLM 的回复语言 | 永远跟随用户消息的语言，LLM 自动处理，无需配置 |

即：`language = "en"` 时用户说中文，LLM 仍然用中文回复。

---

## 配置设计

`config.toml` 新增字段（向后兼容，figment 默认值）：

```toml
[default]
provider = "deepseek"
model = "deepseek-chat"
temperature = 0.7
language = "en"     # 新增，默认英文（开源友好）
```

取值：`"en"`（英文）或 `"zh"`（中文）。

### 语言加载优先级

1. `config.toml` 中显式设置的 `language` 字段
2. 操作系统 `LANG` 环境变量推断（`zh_*` → Chinese，其余 → English）
3. 默认 English

### 向后兼容

- **全新安装**：默认写入 `language = "en"`
- **已有安装升级**（config 无此字段）：从 `LANG` 推断 → 中文用户自动保持中文体验，无感升级

### 热生效（无需重启）

语言设置不存储在 Agent 内存中，每轮 `build_system_prompt` 调用时实时读取 config 文件（与 `http_allowed_hosts` 的设计一致）：

```rust
// Config::get_language() — 实时读文件，不缓存
pub fn get_language() -> Language { ... }
```

用户通过自然语言操作：

```
User: "switch to Chinese"
Agent: → ConfigTool set default.language zh
       → "Language changed to Chinese."
User: (下一条消息)
Agent: → build_system_prompt 读到 zh → 中文版 system prompt 生效
```

CLI 欢迎语（启动时打印一次）需要重启生效，其余均热生效。

---

## 架构设计

### `src/i18n.rs`（新建）

```rust
#[derive(Debug, Clone, Copy, PartialEq)]
pub enum Language {
    English,
    Chinese,
}

impl Language {
    pub fn from_str(s: &str) -> Self {
        match s {
            "zh" | "zh-CN" | "zh-TW" => Self::Chinese,
            _ => Self::English,
        }
    }

    pub fn from_locale() -> Self {
        let lang = std::env::var("LANG").unwrap_or_default();
        if lang.starts_with("zh") { Self::Chinese } else { Self::English }
    }

    /// 优先 config 字段，回退 LANG env var
    pub fn detect(config_lang: &str) -> Self {
        if config_lang.is_empty() {
            Self::from_locale()
        } else {
            Self::from_str(config_lang)
        }
    }
}
```

### `src/config/schema.rs`

`DefaultConfig` 新增字段：

```rust
pub struct DefaultConfig {
    pub provider: String,
    pub model: String,
    pub temperature: f64,
    pub language: String,   // 新增，默认 "en"
}
```

新增实时读取方法（不走 figment，直接读文件）：

```rust
impl Config {
    pub fn get_language() -> Language {
        // 读 config.toml → 取 default.language → Language::detect(val)
        // 失败时回退 from_locale()
    }
}
```

### `src/agent/loop_.rs`

两个 prompt 函数签名变为：

```rust
fn build_routing_prompt(skills: &[SkillMeta], lang: Language) -> String
fn build_system_prompt(&self, memories: &[MemoryEntry]) -> String  // 内部调用 Config::get_language()
```

每种语言有独立的 prompt 实现函数：

```rust
fn build_routing_prompt_en(skills: &[SkillMeta]) -> String { ... }
fn build_routing_prompt_zh(skills: &[SkillMeta]) -> String { ... }  // 现有逻辑

fn build_system_prompt_en(&self, memories: &[MemoryEntry]) -> String { ... }
fn build_system_prompt_zh(&self, memories: &[MemoryEntry]) -> String { ... }  // 现有逻辑
```

---

## 实施阶段

### P9-1: Language 基础设施 + System Prompt（本 session）

**改动文件**：
- `src/config/schema.rs` — 新增 `language` 字段 + `Config::get_language()`
- `src/i18n.rs` — 新建，Language enum
- `src/lib.rs` — 新增 `pub mod i18n`
- `src/agent/loop_.rs` — English routing prompt + system prompt

**提交策略**：
1. `docs: update p9-i18n plan`
2. `feat(config): add language field and Config::get_language()`
3. `feat: add i18n module with Language enum`
4. `feat(agent): add English system prompt`
5. `test: verify language detection and English prompts`

### P9-2: CLI 消息 + Setup 向导

**改动文件**：`src/channels/cli.rs`、`src/config/setup.rs`

涉及的中文字符串（约 30 处）：
- 欢迎语 / 退出语
- 工具确认提示 `"确认执行? [y/N/a]"`
- 错误消息 `"错误:"`
- 斜杠命令帮助文本 `print_help()`
- 历史记录加载提示

做法：`src/i18n.rs` 增加 `UiStrings` 常量组，按 Language 选择。

### P9-3: 英文内置 Skills

新增文件：`src/skills/builtin/*.en.md`（共 5 个 skill 的英文版）

`src/skills/mod.rs` 中 `builtin_skills(lang: Language)` 按语言选择对应文件。

### P9-4: 双 Tokenizer（英文搜索质量）

**背景**：jieba 对英文文本不做 stemming，导致 Memory recall 在英文场景下存在漏召回：
- 存入 "user prefers tabs" → 搜 "preference" → **0 结果**（不是排名靠后，是完全找不到）
- 中文不受影响

**方案**：
- `Language::English` → tantivy 内置 `en_stem` tokenizer（无需新依赖）
- `Language::Chinese` → 保持 `jieba`
- Tokenizer 在 schema 创建时确定，更改需要重建索引
- 解法：检测到语言变更时，删旧索引目录 + 重新建索引（Memory 数据在 SQLite 中不丢失，只索引重建，秒级完成）

---

## 验证

### 自动化测试

```rust
// Language 检测
assert_eq!(Language::from_str("en"), Language::English);
assert_eq!(Language::from_str("zh"), Language::Chinese);
assert_eq!(Language::from_str("zh-CN"), Language::Chinese);
assert_eq!(Language::from_str("fr"), Language::English);  // 未知语言 → English

// English routing prompt
let prompt = build_routing_prompt(&[], Language::English);
assert!(prompt.contains("RRClaw"));
assert!(!prompt.contains("你是"));

// Chinese routing prompt 保持兼容
let prompt = build_routing_prompt(&[], Language::Chinese);
assert!(prompt.contains("你是"));
```

### 手动验证

```bash
# 英文模式
rrclaw agent  # config.toml 中 language = "en"
# 预期：确认提示、帮助文本为英文；和 LLM 说中文，LLM 仍用中文回复

# 中文模式
LANG=zh_CN rrclaw agent  # 或 config 中 language = "zh"
# 预期：体验与升级前完全一致
```
